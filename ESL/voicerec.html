<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue vs Yellow Voice Game</title>
  <style>
    html {
      font-size: 20px;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .timer {
      position: absolute;
      top: 1rem;
      font-size: 2.5rem;
      font-weight: bold;
    }
    #blueTimer {
      left: 2rem;
      color: #3399ff;
    }
    #yellowTimer {
      right: 2rem;
      color: #ffdd33;
    }
    .sentence {
      font-size: 3rem;
      margin: 2rem;
      max-width: 80%;
    }
    .blue {
      color: #3399ff;
    }
    .yellow {
      color: #ffdd33;
    }
    .status {
      margin-top: 1.5rem;
      font-size: 1.6rem;
    }
    .game-over {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 3rem;
      color: white;
      padding: 2rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="blueTimer" class="timer">1:00</div>
  <div id="yellowTimer" class="timer">1:00</div>
  <div id="sentence" class="sentence">Press SPACEBAR to start.</div>
  <div id="status" class="status">Waiting...</div>

  <script>
    class BlueYellowGame {
      constructor() {
        this.blueTime = 60;
        this.yellowTime = 60;
        this.currentTeam = "blue";
        this.gameActive = false;
        this.sentences = [
          "The happy dog is running.",
          "A big cat is sleeping.",
          "The red bird is flying.",
          "A small boy is jumping.",
          "The funny girl is dancing.",
          "A yellow car is moving.",
          "The green frog is hopping.",
          "A blue fish is swimming.",
          "The hot sun is shining.",
          "A cold wind is blowing."
        ];
        this.index = 0;
        this.timer = null;
        this.recognition = null;
        this.blueTimer = document.getElementById("blueTimer");
        this.yellowTimer = document.getElementById("yellowTimer");
        this.sentenceBox = document.getElementById("sentence");
        this.status = document.getElementById("status");
        this.initEvents();
        this.initSpeech();
      }

      initEvents() {
        document.addEventListener("keydown", e => {
          if (e.code === "Space") {
            e.preventDefault();
            if (!this.gameActive) this.start();
          }
        });
      }

      initSpeech() {
        if ('webkitSpeechRecognition' in window) {
          this.recognition = new webkitSpeechRecognition();
        } else if ('SpeechRecognition' in window) {
          this.recognition = new SpeechRecognition();
        }
        if (this.recognition) {
          this.recognition.continuous = true;
          this.recognition.interimResults = true;
          this.recognition.lang = "en-US";
          this.recognition.onresult = e => {
            let final = "";
            for (let i = e.resultIndex; i < e.results.length; i++) {
              if (e.results[i].isFinal) final += e.results[i][0].transcript;
            }
            if (final) {
              console.log("Detected speech:", final);
              this.check(final.trim());
            }
          };
          this.recognition.onend = () => {
            if (this.gameActive) setTimeout(() => this.recognition.start(), 100);
          };
        }
      }

      start() {
        this.blueTime = 60;
        this.yellowTime = 60;
        this.currentTeam = "blue";
        this.index = 0;
        this.gameActive = true;
        this.updateTimers();
        this.showSentence();
        this.status.textContent = "Game started! Blue team, go!";
        this.timer = setInterval(() => this.tick(), 1000);
        if (this.recognition) this.recognition.start();
      }

      tick() {
        if (this.currentTeam === "blue") {
          this.blueTime--;
          if (this.blueTime <= 0) return this.end("Yellow");
        } else {
          this.yellowTime--;
          if (this.yellowTime <= 0) return this.end("Blue");
        }
        this.updateTimers();
      }

      updateTimers() {
        this.blueTimer.textContent = this.format(this.blueTime);
        this.yellowTimer.textContent = this.format(this.yellowTime);
      }

      format(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2, "0")}`;
      }

      showSentence() {
        const s = this.sentences[this.index % this.sentences.length];
        this.sentenceBox.textContent = s;
        this.sentenceBox.className = "sentence " + this.currentTeam;
        this.index++;
      }

      check(spoken) {
        const normalize = str =>
          str.toLowerCase().replace(/[.,!?]/g, "").replace(/\s+/g, " ").trim();

        const target = normalize(this.sentenceBox.textContent);
        const spokenNorm = normalize(spoken);

        console.log("Target:", target);
        console.log("Spoken:", spokenNorm);

        const targetWords = target.split(" ");
        const spokenWords = spokenNorm.split(" ");

        let matchIndex = 0;
        for (let word of spokenWords) {
          if (word === targetWords[matchIndex]) {
            matchIndex++;
            if (matchIndex === targetWords.length) {
              this.switchTeam();
              break;
            }
          }
        }
      }

      switchTeam() {
        this.currentTeam = this.currentTeam === "blue" ? "yellow" : "blue";
        this.showSentence();
        this.status.textContent = `${this.currentTeam === "blue" ? "Blue" : "Yellow"} team, go!`;
      }

      end(winner) {
        this.gameActive = false;
        clearInterval(this.timer);
        if (this.recognition) this.recognition.stop();
        const overlay = document.createElement("div");
        overlay.className = "game-over";
        overlay.textContent = `${winner} team wins! Press SPACEBAR to restart.`;
        document.body.appendChild(overlay);
        const handler = e => {
          if (e.code === "Space") {
            e.preventDefault();
            overlay.remove();
            document.removeEventListener("keydown", handler);
            this.start();
          }
        };
        document.addEventListener("keydown", handler);
      }
    }

    window.addEventListener("DOMContentLoaded", () => new BlueYellowGame());
  </script>
</body>
</html>